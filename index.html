<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C & N Photo Strip</title>
    <style>
        body { 
            background: #d1c4bc; font-family: 'Courier New', Courier, monospace; 
            display: flex; flex-direction: column; align-items: center; padding: 20px;
        }
        
        /* The Camera Viewport */
        #viewport {
            position: relative; width: 320px; height: 240px;
            border: 10px solid white; background: #000; overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* Live Filter CSS */
        .f-none { filter: none; }
        .f-bw { filter: grayscale(1) contrast(1.2); }
        .f-sepia { filter: sepia(1) contrast(1.1); }

        .controls { margin: 20px 0; display: flex; gap: 10px; }
        .btn { 
            padding: 10px 20px; border: 1px solid #704214; background: #f4ecd8; 
            cursor: pointer; font-family: inherit; font-weight: bold;
        }
        .btn.active { background: #704214; color: white; }
        .btn-start { background: #a64452; color: white; border: none; font-size: 1.1rem; }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 5rem; color: white; font-weight: bold; display: none; text-shadow: 0 0 10px black;
        }

        /* The Vertical Strip Preview */
        #strip-container {
            margin-top: 30px; background: #111; padding: 15px;
            display: flex; flex-direction: column; gap: 10px; width: 140px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .header { color: white; text-align: center; font-size: 10px; margin-bottom: 5px; }
        .box { width: 100%; height: 100px; background: #222; object-fit: cover; }
    </style>
</head>
<body>

    <h2>C & N Photobooth</h2>

    <div class="controls">
        <button class="btn active" onclick="setFilter('none', this)">ORIGINAL</button>
        <button class="btn" onclick="setFilter('bw', this)">B&W</button>
        <button class="btn" onclick="setFilter('sepia', this)">SEPIA</button>
    </div>

    <div id="viewport">
        <video id="video" autoplay playsinline class="f-none"></video>
        <div id="countdown">3</div>
    </div>

    <button id="start-btn" class="btn btn-start" style="margin-top:20px;" onclick="runBooth()">START 4 POSES</button>

    <div id="strip-container">
        <div class="header">C & N<br>2026</div>
        <img id="img0" class="box">
        <img id="img1" class="box">
        <img id="img2" class="box">
        <img id="img3" class="box">
    </div>

    <canvas id="mainCanvas" width="600" height="1800" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let currentFilter = 'none';
        let capturedData = [];

        // 1. Start Camera
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => { video.srcObject = stream; })
            .catch(err => alert("Please enable camera access!"));

        function setFilter(type, btn) {
            currentFilter = type;
            video.className = 'f-' + type;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // 2. The Main Logic Loop
        async function runBooth() {
            capturedData = [];
            document.getElementById('start-btn').disabled = true;

            for (let i = 0; i < 4; i++) {
                await countdown(3);
                const frame = captureFrame();
                capturedData.push(frame);
                document.getElementById('img' + i).src = frame;
                await sleep(1000); // 1 second gap
            }

            createFinalStrip();
            document.getElementById('start-btn').disabled = false;
        }

        function countdown(seconds) {
            return new Promise(resolve => {
                const el = document.getElementById('countdown');
                el.style.display = 'block';
                let count = seconds;
                el.innerText = count;
                const timer = setInterval(() => {
                    count--;
                    if (count <= 0) {
                        clearInterval(timer);
                        el.style.display = 'none';
                        resolve();
                    } else {
                        el.innerText = count;
                    }
                }, 1000);
            });
        }

        function captureFrame() {
            const tmp = document.createElement('canvas');
            tmp.width = 600; tmp.height = 450;
            const tCtx = tmp.getContext('2d');
            
            // Mirror
            tCtx.translate(600, 0);
            tCtx.scale(-1, 1);
            
            // Apply the filter permanently to this frame
            if(currentFilter === 'bw') tCtx.filter = 'grayscale(100%) contrast(1.2)';
            if(currentFilter === 'sepia') tCtx.filter = 'sepia(100%) contrast(1.1)';
            
            tCtx.drawImage(video, 0, 0, 600, 450);
            return tmp.toDataURL('image/png');
        }

        

        function createFinalStrip() {
            // Draw Black Strip Background
            ctx.fillStyle = "#111111";
            ctx.fillRect(0, 0, 600, 1800);

            // Add Header Text
            ctx.fillStyle = "white";
            ctx.font = "italic 40px serif";
            ctx.textAlign = "center";
            ctx.fillText("C and N photobooth", 300, 100);

            let imagesLoaded = 0;
            capturedData.forEach((data, i) => {
                const img = new Image();
                img.src = data;
                img.onload = () => {
                    const y = 200 + (i * 380);
                    ctx.drawImage(img, 50, y, 500, 350);
                    
                    // Draw Sticker from your files
                    const sticker = new Image();
                    sticker.src = `fav${i+1}.png`; 
                    sticker.onload = () => {
                        ctx.drawImage(sticker, 400, y + 200, 140, 140);
                        imagesLoaded++;
                        if (imagesLoaded === 4) downloadResult();
                    };
                    sticker.onerror = () => { // If sticker fails, still continue
                        imagesLoaded++;
                        if (imagesLoaded === 4) downloadResult();
                    };
                };
            });
        }

        function downloadResult() {
            const dataURL = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = 'CN-Strip-2026.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    </script>
</body>
</html>
