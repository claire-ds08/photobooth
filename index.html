<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C & N Vintage Booth</title>
    <style>
        :root { --cream: #f4ecd8; --sepia: #704214; }
        body { 
            background: #d7ccc8; font-family: 'Courier New', Courier, monospace; 
            display: flex; flex-direction: column; align-items: center; padding: 20px;
            color: var(--sepia);
        }
        
        .controls { margin-bottom: 15px; display: flex; gap: 8px; }
        .filter-btn { 
            padding: 8px 12px; border: 1px solid var(--sepia); 
            background: var(--cream); cursor: pointer; font-family: inherit;
        }
        .filter-btn.active { background: var(--sepia); color: white; }

        #camera-container {
            position: relative; width: 320px; height: 320px;
            border: 10px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: #000; overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* Filter Classes */
        .bw-filter { filter: grayscale(1) contrast(1.2); }
        .sepia-filter { filter: sepia(1) contrast(1.1); }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 5rem; color: white; font-weight: bold; z-index: 10; display: none;
        }

        .main-btn {
            margin-top: 20px; padding: 15px 40px; background: #a64452;
            color: white; border: none; cursor: pointer; font-size: 1.1rem;
            font-family: inherit; letter-spacing: 1px;
        }

        #status { margin-top: 15px; font-size: 0.9rem; letter-spacing: 1px; }

        #gallery { margin-top: 30px; display: flex; flex-direction: column; gap: 20px; }
        .strip-output { 
            background: white; padding: 15px 15px 40px 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 200px;
        }
        .strip-output img { width: 100%; }
    </style>
</head>
<body>

    <h2 style="letter-spacing: 4px;">PHOTO AUTOMAT</h2>
    
    <div class="controls">
        <button class="filter-btn active" onclick="setFilter('none', this)">ORIGINAL</button>
        <button class="filter-btn" onclick="setFilter('bw', this)">B&W</button>
        <button class="filter-btn" onclick="setFilter('sepia', this)">SEPIA</button>
    </div>

    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <div id="countdown">3</div>
    </div>

    <div id="status">CHOOSE A FILTER & PRESS START</div>
    <button id="start-btn" class="main-btn" onclick="startSequence()">START 4-SHOTS</button>

    <div id="gallery"></div>

    <canvas id="stripCanvas" style="display:none;" width="600" height="2200"></canvas>

    <script>
        const video = document.getElementById('video');
        const countdownEl = document.getElementById('countdown');
        const statusEl = document.getElementById('status');
        let currentFilter = 'none';
        let shots = [];
        let isCapturing = false;

        // Load Stickers
        const stickers = [new Image(), new Image(), new Image(), new Image()];
        stickers[0].src = 'fav1.png'; stickers[1].src = 'fav2.png';
        stickers[2].src = 'fav3.png'; stickers[3].src = 'fav4.png';

        navigator.mediaDevices.getUserMedia({ video: { aspectRatio: 1 } }).then(s => video.srcObject = s);

        function setFilter(type, btn) {
            if(isCapturing) return;
            currentFilter = type;
            video.className = '';
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(type === 'bw') video.classList.add('bw-filter');
            if(type === 'sepia') video.classList.add('sepia-filter');
        }

        async function startSequence() {
            if(isCapturing) return;
            isCapturing = true;
            shots = [];
            document.getElementById('start-btn').style.opacity = '0.5';
            
            for(let i=0; i<4; i++) {
                statusEl.innerText = `GET READY FOR POSE ${i+1}...`;
                await runCountdown();
                captureShot();
                await new Promise(res => setTimeout(res, 1200)); 
            }
            
            statusEl.innerText = "DEVELOPING STRIP...";
            generateStrip();
            isCapturing = false;
            document.getElementById('start-btn').style.opacity = '1';
        }

        function runCountdown() {
            return new Promise(resolve => {
                let count = 3;
                countdownEl.style.display = 'block';
                countdownEl.innerText = count;
                let timer = setInterval(() => {
                    count--;
                    if(count > 0) countdownEl.innerText = count;
                    else {
                        clearInterval(timer);
                        countdownEl.style.display = 'none';
                        resolve();
                    }
                }, 1000);
            });
        }

        function captureShot() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 600; tempCanvas.height = 450;
            const ctx = tempCanvas.getContext('2d');
            
            // Mirror & Filter logic for the shot
            ctx.translate(600, 0); ctx.scale(-1, 1);
            if(currentFilter === 'bw') ctx.filter = 'grayscale(1) contrast(1.2)';
            if(currentFilter === 'sepia') ctx.filter = 'sepia(1) contrast(1.1)';
            
            ctx.drawImage(video, 0, 0, 600, 450);
            shots.push(tempCanvas.toDataURL('image/png'));
        }

        function generateStrip() {
            const canvas = document.getElementById('stripCanvas');
            const ctx = canvas.getContext('2d');
            
            // 1. Vintage White/Cream Background
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, 600, 2200);

            // 2. Draw 4 shots vertically
            let loaded = 0;
            shots.forEach((shotData, i) => {
                const img = new Image();
                img.src = shotData;
                img.onload = () => {
                    const yPos = 40 + (i * 480);
                    ctx.drawImage(img, 40, yPos, 520, 440);
                    
                    // 3. Place Stickers at corners
                    const sticker = stickers[i];
                    ctx.save();
                    // Positioning: Sticker on the bottom right of each frame
                    const sx = 400; const sy = yPos + 300;
                    // White outline effect for sticker
                    ctx.shadowColor = "white"; ctx.shadowBlur = 8;
                    ctx.drawImage(sticker, sx, sy, 140, 140);
                    ctx.restore();

                    loaded++;
                    if(loaded === 4) finishStrip(canvas);
                };
            });
        }

        function finishStrip(canvas) {
            const ctx = canvas.getContext('2d');
            // 4. Minimal Typewriter Footer
            ctx.fillStyle = "#3e2723";
            ctx.font = "32px 'Courier New'";
            ctx.textAlign = "center";
            ctx.fillText("C and N photobooth", 300, 2050);
            ctx.font = "20px 'Courier New'";
            ctx.fillText(new Date().toLocaleDateString(), 300, 2100);

            const finalUrl = canvas.toDataURL('image/png');
            
            // Show in Gallery
            const gallery = document.getElementById('gallery');
            const div = document.createElement('div');
            div.className = 'strip-output';
            div.innerHTML = `<img src="${finalUrl}"><p style="font-size:10px;margin-top:10px;">SAVED TO GALLERY</p>`;
            gallery.prepend(div);

            // Auto Download
            const link = document.createElement('a');
            link.download = `CN-Booth-${Date.now()}.png`;
            link.href = finalUrl;
            link.click();
            
            statusEl.innerText = "STRIP SAVED!";
        }
    </script>
</body>
</html>
