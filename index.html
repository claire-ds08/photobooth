<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C & N Vintage Booth</title>
    <style>
        body { 
            background: #d1c4bc; font-family: 'Courier New', Courier, monospace; 
            display: flex; flex-direction: column; align-items: center; padding: 20px;
        }
        
        #viewport-container {
            position: relative; width: 320px; height: 240px;
            border: 10px solid white; background: #000; overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* Hearts Overlay Animation */
        #hearts-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: none; background-image: url('https://cdn-icons-png.flaticon.com/512/833/833472.png');
            background-size: 50px; opacity: 0.6; animation: floatHearts 3s infinite linear;
        }
        @keyframes floatHearts {
            0% { background-position: 0 0; }
            100% { background-position: 0 -100px; }
        }

        /* Filter Classes for Preview */
        .f-bw { filter: grayscale(1) contrast(1.2); }
        .f-sepia { filter: sepia(1) contrast(1.1); }
        .f-fisheye { transform: scaleX(-1) scale(1.3); border-radius: 50%; }

        .controls { margin: 20px 0; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        .btn { 
            padding: 8px 12px; border: 1px solid #704214; background: #f4ecd8; 
            cursor: pointer; font-family: inherit; font-size: 0.8rem;
        }
        .btn.active { background: #704214; color: white; }
        .btn-start { background: #a64452; color: white; border: none; font-size: 1rem; padding: 12px 25px; }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 5rem; color: white; font-weight: bold; z-index: 10; display: none;
        }

        #strip-preview {
            margin-top: 20px; background: #111; padding: 10px;
            display: flex; flex-direction: column; gap: 5px; width: 120px;
        }
        .box { width: 100%; height: 80px; background: #222; object-fit: cover; }
        .header { color: white; text-align: center; font-size: 8px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <h2>C & N Photobooth</h2>

    <div class="controls">
        <button class="btn active" onclick="setFilter('none', this)">ORIGINAL</button>
        <button class="btn" onclick="setFilter('bw', this)">B&W</button>
        <button class="btn" onclick="setFilter('sepia', this)">SEPIA</button>
        <button class="btn" onclick="setFilter('fisheye', this)">FISHEYE</button>
        <button class="btn" onclick="setFilter('hearts', this)">HEARTS</button>
    </div>

    <div id="viewport-container">
        <video id="video" autoplay playsinline></video>
        <div id="hearts-overlay"></div>
        <div id="countdown">3</div>
    </div>

    <button id="start-btn" class="btn btn-start" style="margin-top:20px;" onclick="runBooth()">START 4 POSES</button>

    <div id="strip-preview">
        <div class="header">C and N photobooth</div>
        <img id="img0" class="box">
        <img id="img1" class="box">
        <img id="img2" class="box">
        <img id="img3" class="box">
    </div>

    <canvas id="mainCanvas" width="600" height="1800" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const hearts = document.getElementById('hearts-overlay');
        let currentFilter = 'none';
        let capturedData = [];

        navigator.mediaDevices.getUserMedia({ video: true }).then(s => video.srcObject = s);

        function setFilter(type, btn) {
            currentFilter = type;
            video.className = 'f-' + type;
            hearts.style.display = (type === 'hearts') ? 'block' : 'none';
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        async function runBooth() {
            capturedData = [];
            document.getElementById('start-btn').disabled = true;

            for (let i = 0; i < 4; i++) {
                await countdown(3);
                capturedData.push(captureFrame());
                document.getElementById('img' + i).src = capturedData[i];
                await new Promise(r => setTimeout(r, 1000));
            }

            createFinalStrip();
            document.getElementById('start-btn').disabled = false;
        }

        function countdown(s) {
            return new Promise(res => {
                const el = document.getElementById('countdown');
                el.style.display = 'block';
                let c = s;
                el.innerText = c;
                const t = setInterval(() => {
                    c--;
                    if (c <= 0) { clearInterval(t); el.style.display = 'none'; res(); }
                    else { el.innerText = c; }
                }, 1000);
            });
        }

        function captureFrame() {
            const tmp = document.createElement('canvas');
            tmp.width = 600; tmp.height = 450;
            const tCtx = tmp.getContext('2d');
            
            // Mirror
            tCtx.translate(600, 0); tCtx.scale(-1, 1);
            
            // APPLY PERMANENT FILTERS TO SAVED DATA
            if(currentFilter === 'bw') tCtx.filter = 'grayscale(100%) contrast(1.2)';
            if(currentFilter === 'sepia') tCtx.filter = 'sepia(100%) contrast(1.1)';
            
            // Fisheye simulation (Center Crop + Scale)
            if(currentFilter === 'fisheye') {
                tCtx.drawImage(video, 50, 50, 500, 350, 0, 0, 600, 450);
            } else {
                tCtx.drawImage(video, 0, 0, 600, 450);
            }

            // Hearts Overlay for saved image
            if(currentFilter === 'hearts') {
                tCtx.scale(-1, 1); tCtx.translate(-600, 0); // Unmirror for icon
                tCtx.globalAlpha = 0.5;
                const heartIcon = new Image();
                heartIcon.src = 'https://cdn-icons-png.flaticon.com/512/833/833472.png';
                // Note: In a real app, you'd wait for this to load, but for simplicity:
                tCtx.drawImage(heartIcon, 50, 50, 100, 100);
                tCtx.drawImage(heartIcon, 450, 300, 100, 100);
            }

            return tmp.toDataURL('image/png');
        }

        function createFinalStrip() {
            ctx.fillStyle = "#111111";
            ctx.fillRect(0, 0, 600, 1800);
            ctx.fillStyle = "white";
            ctx.font = "italic 35px 'Courier New'";
            ctx.textAlign = "center";
            ctx.fillText("C and N photobooth", 300, 120);

            let loaded = 0;
            capturedData.forEach((data, i) => {
                const img = new Image();
                img.src = data;
                img.onload = () => {
                    const y = 200 + (i * 385);
                    ctx.drawImage(img, 40, y, 520, 360);
                    loaded++;
                    if (loaded === 4) downloadStrip();
                };
            });
        }

        function downloadStrip() {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = `CN-Booth-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
