<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C & N Booth V2</title>
    <style>
        body { background: #d1c4bc; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        /* Camera Preview */
        #viewport {
            position: relative; width: 320px; height: 240px;
            border: 8px solid white; background: #000; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* Filter Styles */
        .f-bw { filter: grayscale(1) contrast(1.2); }
        .f-sepia { filter: sepia(1) contrast(1.1); }
        .f-fisheye { transform: scaleX(-1) scale(1.4); } /* Digital zoom for fisheye look */

        /* Animated Hearts CSS */
        #heart-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: none; z-index: 5;
            background: url('https://upload.wikimedia.org/wikipedia/commons/4/42/Love_Heart_SVG.svg') repeat;
            background-size: 40px; opacity: 0.4; animation: heartMove 4s infinite linear;
        }
        @keyframes heartMove { from { background-position: 0 0; } to { background-position: 0 100px; } }

        .controls { margin: 15px; display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
        .btn { padding: 8px 12px; border: 1px solid #704214; background: #f4ecd8; cursor: pointer; font-family: inherit; }
        .btn.active { background: #704214; color: white; }
        .start-btn { background: #a64452; color: white; border: none; padding: 12px 30px; font-size: 1rem; margin-top: 10px; }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 5rem; color: white; font-weight: bold; z-index: 10; display: none;
        }

        #preview-strip {
            margin-top: 20px; background: #111; padding: 12px;
            display: flex; flex-direction: column; gap: 8px; width: 130px;
        }
        .shot { width: 100%; height: 90px; background: #222; object-fit: cover; border: 1px solid #333; }
        .footer-label { color: white; text-align: center; font-size: 9px; margin-top: 5px; opacity: 0.8; }
    </style>
</head>
<body>

    <h2 style="letter-spacing: 2px;">PHOTO AUTOMAT</h2>

    <div class="controls">
        <button class="btn active" onclick="updateFilter('none', this)">ORIGINAL</button>
        <button class="btn" onclick="updateFilter('bw', this)">B&W</button>
        <button class="btn" onclick="updateFilter('sepia', this)">SEPIA</button>
        <button class="btn" onclick="updateFilter('fisheye', this)">FISHEYE</button>
        <button class="btn" onclick="updateFilter('hearts', this)">HEARTS</button>
    </div>

    <div id="viewport">
        <video id="video" autoplay playsinline></video>
        <div id="heart-screen"></div>
        <div id="countdown"></div>
    </div>

    <button id="main-action" class="btn start-btn" onclick="takeFourShots()">START 4-SHOTS</button>

    <div id="preview-strip">
        <img id="p0" class="shot">
        <img id="p1" class="shot">
        <img id="p2" class="shot">
        <img id="p3" class="shot">
        <div class="footer-label">C and N photobooth</div>
    </div>

    <canvas id="canvas" width="600" height="1800" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const heartLayer = document.getElementById('heart-screen');
        let currentFilter = 'none';
        let photos = [];

        navigator.mediaDevices.getUserMedia({ video: true }).then(s => video.srcObject = s);

        function updateFilter(type, btn) {
            currentFilter = type;
            video.className = 'f-' + type;
            heartLayer.style.display = (type === 'hearts') ? 'block' : 'none';
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        async function takeFourShots() {
            photos = [];
            document.getElementById('main-action').disabled = true;

            for (let i = 0; i < 4; i++) {
                await runTimer(3);
                const data = captureToData();
                photos.push(data);
                document.getElementById('p' + i).src = data;
                await new Promise(r => setTimeout(r, 800));
            }

            renderFinalStrip();
            document.getElementById('main-action').disabled = false;
        }

        function runTimer(sec) {
            return new Promise(res => {
                const countEl = document.getElementById('countdown');
                countEl.style.display = 'block';
                let time = sec;
                countEl.innerText = time;
                const timer = setInterval(() => {
                    time--;
                    if (time <= 0) { clearInterval(timer); countEl.style.display = 'none'; res(); }
                    else { countEl.innerText = time; }
                }, 1000);
            });
        }

        function captureToData() {
            const temp = document.createElement('canvas');
            temp.width = 600; temp.height = 450;
            const tCtx = temp.getContext('2d');

            // 1. Mirror
            tCtx.translate(600, 0); tCtx.scale(-1, 1);

            // 2. Apply Baked-in Filters
            if(currentFilter === 'bw') tCtx.filter = 'grayscale(100%) contrast(120%)';
            if(currentFilter === 'sepia') tCtx.filter = 'sepia(100%) contrast(110%)';
            
            // Fisheye (Center zoom)
            if(currentFilter === 'fisheye') {
                tCtx.drawImage(video, 60, 45, 480, 360, 0, 0, 600, 450);
            } else {
                tCtx.drawImage(video, 0, 0, 600, 450);
            }

            // Hearts (Drawn on frame)
            if(currentFilter === 'hearts') {
                tCtx.filter = 'none'; // reset filter for hearts
                tCtx.fillStyle = "rgba(255, 0, 0, 0.3)";
                // Drawing simple heart placeholders
                tCtx.font = "60px Arial";
                tCtx.fillText("❤️", -100, 100); 
                tCtx.fillText("❤️", -500, 400);
            }

            return temp.toDataURL('image/png');
        }

        

        function renderFinalStrip() {
            // Draw Black Background
            ctx.fillStyle = "#111111";
            ctx.fillRect(0, 0, 600, 1800);

            let loaded = 0;
            photos.forEach((src, i) => {
                const img = new Image();
                img.src = src;
                img.onload = () => {
                    ctx.drawImage(img, 40, 180 + (i * 390), 520, 360);
                    loaded++;
                    if (loaded === 4) {
                        // Footer Text
                        ctx.fillStyle = "white";
                        ctx.font = "24px 'Courier New'";
                        ctx.textAlign = "center";
                        ctx.fillText("C and N photobooth", 300, 1750);
                        
                        // Download Trigger
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = `CN_Booth_${Date.now()}.png`;
                        link.click();
                    }
                };
            });
        }
    </script>
</body>
</html>
