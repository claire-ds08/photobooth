<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C & N Photobooth</title>
    <style>
        body { 
            background: #d7ccc8; font-family: 'Courier New', Courier, monospace; 
            display: flex; flex-direction: column; align-items: center; padding: 20px;
        }
        /* Filter Styles for the Video Preview */
        .none { filter: none; }
        .bw { filter: grayscale(1) contrast(1.2) brightness(1.1); }
        .sepia { filter: sepia(1) contrast(1.1) brightness(0.9); }

        #camera-wrapper {
            position: relative; width: 300px; height: 300px;
            border: 10px solid white; box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            background: #000; overflow: hidden; margin-bottom: 20px;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .controls { margin-bottom: 15px; display: flex; gap: 10px; }
        .filter-btn { 
            padding: 8px 15px; border: 1px solid #704214; 
            background: #f4ecd8; cursor: pointer; font-family: inherit;
        }
        .filter-btn.active { background: #704214; color: white; }

        .main-btn {
            padding: 15px 40px; background: #a64452; color: white; 
            border: none; cursor: pointer; font-size: 1.1rem; font-family: inherit;
        }
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 5rem; color: white; font-weight: bold; z-index: 10; display: none;
        }
        #gallery { margin-top: 30px; }
        .final-strip { background: white; padding: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); width: 160px; }
    </style>
</head>
<body>

    <h2 style="letter-spacing: 2px;">C & N PHOTOBOOTH</h2>

    <div class="controls">
        <button class="filter-btn active" onclick="updateFilter('none', this)">ORIGINAL</button>
        <button class="filter-btn" onclick="updateFilter('bw', this)">B&W</button>
        <button class="filter-btn" onclick="updateFilter('sepia', this)">SEPIA</button>
    </div>

    <div id="camera-wrapper">
        <video id="video" autoplay playsinline class="none"></video>
        <div id="countdown">3</div>
    </div>

    <button id="snap-btn" class="main-btn" onclick="startBooth()">START SESSION</button>
    <p id="status">4 shots will be taken automatically</p>

    <div id="gallery"></div>

    <canvas id="stripCanvas" width="500" height="1800" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const countdownEl = document.getElementById('countdown');
        const canvas = document.getElementById('stripCanvas');
        const ctx = canvas.getContext('2d');
        let selectedFilter = 'none';
        let shots = [];

        // Preload Stickers
        const stickers = ["fav1.png", "fav2.png", "fav3.png", "fav4.png"].map(src => {
            const img = new Image();
            img.src = src;
            return img;
        });

        navigator.mediaDevices.getUserMedia({ video: { aspectRatio: 1 } }).then(s => video.srcObject = s);

        function updateFilter(type, btn) {
            selectedFilter = type;
            video.className = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        async function startBooth() {
            shots = [];
            document.getElementById('snap-btn').disabled = true;
            
            for (let i = 0; i < 4; i++) {
                await runCountdown();
                captureSingleShot();
                await new Promise(r => setTimeout(r, 1000));
            }
            
            assembleStrip();
            document.getElementById('snap-btn').disabled = false;
        }

        function runCountdown() {
            return new Promise(res => {
                let count = 3;
                countdownEl.style.display = 'block';
                countdownEl.innerText = count;
                let timer = setInterval(() => {
                    count--;
                    if(count > 0) countdownEl.innerText = count;
                    else { clearInterval(timer); countdownEl.style.display = 'none'; res(); }
                }, 1000);
            });
        }

        function captureSingleShot() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 440; tempCanvas.height = 380;
            const tCtx = tempCanvas.getContext('2d');
            
            // Mirror
            tCtx.translate(440, 0); tCtx.scale(-1, 1);
            
            // APPLY FILTER TO CANVAS
            if(selectedFilter === 'bw') tCtx.filter = 'grayscale(1) contrast(1.2)';
            if(selectedFilter === 'sepia') tCtx.filter = 'sepia(1) contrast(1.1)';
            
            tCtx.drawImage(video, 0, 0, 440, 380);
            shots.push(tempCanvas.toDataURL('image/png'));
        }

        function assembleStrip() {
            // 1. Background
            ctx.fillStyle = "white";
            ctx.
